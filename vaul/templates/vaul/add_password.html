{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="card" style="max-width:560px;margin:24px auto;">
  <h2>Agregar contraseña</h2>
  <form method="post" action="{% url 'add_password' %}" class="grid">
    {% csrf_token %}
    <div class="field">
      <label>Nombre del sitio</label>
      <input type="text" name="site_name" placeholder="Nombre del sitio" value="{{ site_name|default:'' }}" required>
    </div>
    <div class="field">
      <label>URL del sitio</label>
      <input type="url" name="site_url" placeholder="https://..." value="{{ site_url|default:'' }}" required>
    </div>
    <div class="field">
      <label>Usuario</label>
      <input type="text" name="username" placeholder="Usuario" value="{{ username|default:'' }}" required>
    </div>
    <div class="field">
      <label>Categoría</label>
      <select name="category" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0b1220; color: var(--text);">
        <option value="other">Otro</option>
        <option value="work">Trabajo</option>
        <option value="personal">Personal</option>
        <option value="social">Redes Sociales</option>
        <option value="finance">Finanzas</option>
        <option value="shopping">Compras</option>
        <option value="entertainment">Entretenimiento</option>
        <option value="education">Educación</option>
      </select>
    </div>
    <div class="field">
      <label>Contraseña</label>
      <div style="display:flex; gap:8px;">
        <input id="add-password" type="password" name="password" placeholder="Contraseña" style="flex:1;" required>
        <button id="toggle-add-pass" type="button" class="btn">Mostrar</button>
        <button id="generate-password" type="button" class="btn" title="Generar contraseña segura">
          <i class="fas fa-key"></i>
        </button>
      </div>
      <div style="margin-top:8px; display:grid; gap:6px;">
        <meter id="add-meter" min="0" max="5" low="2" high="4" optimum="5" value="0"></meter>
        <small id="add-label" class="muted">Fortaleza: Muy débil</small>
      </div>
    </div>
    <div class="field">
      <label>Notas (opcional)</label>
      <textarea name="notes" placeholder="Información adicional sobre esta contraseña..." rows="3" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0b1220; color: var(--text); resize: vertical;">{{ notes|default:'' }}</textarea>
    </div>
    <div>
      <button type="submit" class="btn primary">Guardar</button>
      <a class="btn" href="{% url 'dashboard' %}">Cancelar</a>
    </div>
  </form>
</div>

<script>
// Funciones inline para evitar problemas de carga de módulos
(function() {
    function initAddPassword() {
        const passwordInput = document.getElementById('add-password');
        const toggleBtn = document.getElementById('toggle-add-pass');
        const generateBtn = document.getElementById('generate-password');
        const meter = document.getElementById('add-meter');
        const label = document.getElementById('add-label');
        
        if (!passwordInput || !toggleBtn || !generateBtn) {
            console.error('Elementos no encontrados');
            return;
        }
        
        // Función para calcular fortaleza de contraseña
        function calculatePasswordStrength(password) {
            let score = 0;
            if (!password) return 0;
            if (password.length >= 8) score += 1;
            if (password.length >= 12) score += 1;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score += 1;
            if (/\d/.test(password)) score += 1;
            if (/[^A-Za-z0-9]/.test(password)) score += 1;
            return Math.min(score, 5);
        }
        
        // Función para actualizar el medidor
        function updateStrengthMeter() {
            if (meter && label) {
                const score = calculatePasswordStrength(passwordInput.value);
                meter.value = score;
                const texts = ['Muy débil', 'Débil', 'Aceptable', 'Buena', 'Fuerte', 'Muy fuerte'];
                label.textContent = 'Fortaleza: ' + (texts[score] || 'Muy débil');
            }
        }
        
        // Función para generar contraseña
        function generatePassword(length = 16) {
            const uppercase = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            const lowercase = 'abcdefghijkmnpqrstuvwxyz';
            const numbers = '23456789';
            const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
            const charset = uppercase + lowercase + numbers + symbols;
            
            let password = '';
            const charsetArray = charset.split('');
            
            // Asegurar al menos un carácter de cada tipo
            password += uppercase[Math.floor(Math.random() * uppercase.length)];
            password += lowercase[Math.floor(Math.random() * lowercase.length)];
            password += numbers[Math.floor(Math.random() * numbers.length)];
            password += symbols[Math.floor(Math.random() * symbols.length)];
            
            // Completar hasta la longitud deseada
            while (password.length < length) {
                password += charsetArray[Math.floor(Math.random() * charsetArray.length)];
            }
            
            // Mezclar la contraseña
            return password.split('').sort(() => Math.random() - 0.5).join('');
        }
        
        // Función para mostrar toast
        function showToast(message, type = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.position = 'fixed';
                container.style.right = '16px';
                container.style.bottom = '16px';
                container.style.display = 'grid';
                container.style.gap = '8px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }
            const el = document.createElement('div');
            el.textContent = message;
            el.style.padding = '10px 12px';
            el.style.borderRadius = '10px';
            el.style.border = '1px solid #1f2937';
            el.style.background = type === 'error' ? '#3f1d1d' : (type === 'success' ? '#022c22' : '#111827');
            el.style.color = type === 'error' ? '#fecaca' : (type === 'success' ? '#a7f3d0' : '#e5e7eb');
            container.appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }
        
        // Event listener para el medidor de fortaleza
        passwordInput.addEventListener('input', updateStrengthMeter);
        updateStrengthMeter();
        
        // Event listener para el botón de mostrar/ocultar
        toggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'Ocultar';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'Mostrar';
            }
        });
        
        // Event listener para el generador de contraseñas
        generateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            try {
                const generated = generatePassword(16);
                passwordInput.value = generated;
                passwordInput.type = 'text';
                toggleBtn.textContent = 'Ocultar';
                updateStrengthMeter();
                showToast('Contraseña generada', 'success');
            } catch (error) {
                console.error('Error generando contraseña:', error);
                showToast('Error al generar contraseña', 'error');
            }
        });
        
        // Prevenir doble envío del formulario
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function() {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Procesando...';
                }
            });
        }
    }
    
    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAddPassword);
    } else {
        // Si ya está cargado, ejecutar inmediatamente
        setTimeout(initAddPassword, 100);
    }
})();
</script>
{% endblock %}
