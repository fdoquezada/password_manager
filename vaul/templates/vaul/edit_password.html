{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="card" style="max-width:560px;margin:24px auto;">
  <h2>Editar entrada</h2>
  <form method="post" action="{% url 'edit_password' entry.id %}" class="grid">
    {% csrf_token %}
    <div class="field">
      <label>Nombre del sitio</label>
      <input type="text" name="site_name" value="{{ entry.site_name }}" placeholder="Nombre del sitio" required>
    </div>
    <div class="field">
      <label>URL del sitio</label>
      <input type="url" name="site_url" value="{{ entry.site_url }}" placeholder="https://..." required>
    </div>
    <div class="field">
      <label>Usuario</label>
      <input type="text" name="username" value="{{ entry.username }}" placeholder="Usuario" required>
    </div>
    <div class="field">
      <label>Categoría</label>
      <select name="category" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0b1220; color: var(--text);">
        <option value="other" {% if entry.category == 'other' %}selected{% endif %}>Otro</option>
        <option value="work" {% if entry.category == 'work' %}selected{% endif %}>Trabajo</option>
        <option value="personal" {% if entry.category == 'personal' %}selected{% endif %}>Personal</option>
        <option value="social" {% if entry.category == 'social' %}selected{% endif %}>Redes Sociales</option>
        <option value="finance" {% if entry.category == 'finance' %}selected{% endif %}>Finanzas</option>
        <option value="shopping" {% if entry.category == 'shopping' %}selected{% endif %}>Compras</option>
        <option value="entertainment" {% if entry.category == 'entertainment' %}selected{% endif %}>Entretenimiento</option>
        <option value="education" {% if entry.category == 'education' %}selected{% endif %}>Educación</option>
      </select>
    </div>
    <div class="field">
      <label>Contraseña actual</label>
      <div style="display:flex; gap:8px; align-items:center; padding: 8px; background: #0b1220; border-radius: 8px; border: 1px solid #374151;">
        <span id="current-pwd-mask-{{ entry.id }}" style="flex:1; font-family: monospace;">••••••••</span>
        <span id="current-pwd-value-{{ entry.id }}" style="flex:1; font-family: monospace; display:none;"></span>
        <button id="btn-show-current-{{ entry.id }}" type="button" class="btn" onclick="showCurrentPassword({{ entry.id }})">Mostrar</button>
        <button type="button" class="btn" onclick="copyCurrentPassword({{ entry.id }})" title="Copiar contraseña actual">
          <i class="fas fa-copy"></i>
        </button>
      </div>
      <small class="muted" style="margin-top: 4px; display: block;">La contraseña actual se muestra solo cuando la revelas por seguridad</small>
    </div>
    <div class="field">
      <label>Nueva contraseña (dejar en blanco para no cambiar)</label>
      <div style="display:flex; gap:8px;">
        <input id="edit-password" type="password" name="password" placeholder="Nueva contraseña" style="flex:1;">
        <button id="toggle-edit-pass" type="button" class="btn">Mostrar</button>
        <button id="generate-edit-password" type="button" class="btn" title="Generar contraseña segura">
          <i class="fas fa-key"></i>
        </button>
      </div>
      <div style="margin-top:8px; display:grid; gap:6px;">
        <meter id="edit-meter" min="0" max="5" low="2" high="4" optimum="5" value="0"></meter>
        <small id="edit-label" class="muted">Fortaleza: Muy débil</small>
      </div>
    </div>
    <div class="field">
      <label>Notas (opcional)</label>
      <textarea name="notes" placeholder="Información adicional sobre esta contraseña..." rows="3" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0b1220; color: var(--text); resize: vertical;">{{ entry.notes|default:'' }}</textarea>
    </div>
    <div>
      <button type="submit" class="btn primary">Guardar cambios</button>
      <a class="btn" href="{% url 'dashboard' %}">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}

<script>
// Función para obtener CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para mostrar la contraseña actual
async function showCurrentPassword(entryId) {
    const maskEl = document.getElementById(`current-pwd-mask-${entryId}`);
    const valEl = document.getElementById(`current-pwd-value-${entryId}`);
    const btn = document.getElementById(`btn-show-current-${entryId}`);
    
    if (!maskEl || !valEl || !btn) return;
    
    // Si ya está visible, ocultamos
    if (valEl.style.display === 'inline' || valEl.style.display === 'block') {
        valEl.style.display = 'none';
        maskEl.style.display = 'inline';
        btn.textContent = 'Mostrar';
        return;
    }
    
    // Si ya está cargada, solo mostramos
    if (valEl.textContent && valEl.textContent.trim().length > 0) {
        maskEl.style.display = 'none';
        valEl.style.display = 'block';
        btn.textContent = 'Ocultar';
        return;
    }
    
    // Primera vez: pedimos al servidor
    const csrftoken = getCookie('csrftoken');
    btn.disabled = true;
    btn.textContent = 'Cargando...';
    
    try {
        const resp = await fetch(`/reveal/${entryId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({})
        });
        
        if (!resp.ok) {
            throw new Error('No se pudo recuperar la contraseña');
        }
        
        const data = await resp.json();
        if (data && data.password) {
            maskEl.style.display = 'none';
            valEl.textContent = data.password;
            valEl.style.display = 'block';
            btn.textContent = 'Ocultar';
            btn.disabled = false;
        } else {
            throw new Error('Respuesta inválida del servidor');
        }
    } catch (e) {
        btn.disabled = false;
        btn.textContent = 'Mostrar';
        alert('Error: ' + (e.message || 'No se pudo recuperar la contraseña'));
    }
}

// Función para copiar la contraseña actual
async function copyCurrentPassword(entryId) {
    const valEl = document.getElementById(`current-pwd-value-${entryId}`);
    
    // Si no está visible, primero la mostramos
    if (!valEl || valEl.style.display === 'none' || !valEl.textContent) {
        await showCurrentPassword(entryId);
        // Esperar un momento para que se cargue
        await new Promise(resolve => setTimeout(resolve, 300));
    }
    
    const password = valEl.textContent;
    if (password) {
        try {
            await navigator.clipboard.writeText(password);
            alert('Contraseña copiada al portapapeles');
        } catch (e) {
            alert('No se pudo copiar la contraseña');
        }
    }
}
</script>

<script>
// Funciones inline para evitar problemas de carga de módulos
(function() {
    function initEditPassword() {
        const passwordInput = document.getElementById('edit-password');
        const toggleBtn = document.getElementById('toggle-edit-pass');
        const generateBtn = document.getElementById('generate-edit-password');
        const meter = document.getElementById('edit-meter');
        const label = document.getElementById('edit-label');
        
        if (!passwordInput || !toggleBtn || !generateBtn) {
            console.error('Elementos no encontrados');
            return;
        }
        
        // Función para calcular fortaleza de contraseña
        function calculatePasswordStrength(password) {
            let score = 0;
            if (!password) return 0;
            if (password.length >= 8) score += 1;
            if (password.length >= 12) score += 1;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score += 1;
            if (/\d/.test(password)) score += 1;
            if (/[^A-Za-z0-9]/.test(password)) score += 1;
            return Math.min(score, 5);
        }
        
        // Función para actualizar el medidor
        function updateStrengthMeter() {
            if (meter && label) {
                const score = calculatePasswordStrength(passwordInput.value);
                meter.value = score;
                const texts = ['Muy débil', 'Débil', 'Aceptable', 'Buena', 'Fuerte', 'Muy fuerte'];
                label.textContent = 'Fortaleza: ' + (texts[score] || 'Muy débil');
            }
        }
        
        // Función para generar contraseña
        function generatePassword(length = 16) {
            const uppercase = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            const lowercase = 'abcdefghijkmnpqrstuvwxyz';
            const numbers = '23456789';
            const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
            const charset = uppercase + lowercase + numbers + symbols;
            
            let password = '';
            const charsetArray = charset.split('');
            
            // Asegurar al menos un carácter de cada tipo
            password += uppercase[Math.floor(Math.random() * uppercase.length)];
            password += lowercase[Math.floor(Math.random() * lowercase.length)];
            password += numbers[Math.floor(Math.random() * numbers.length)];
            password += symbols[Math.floor(Math.random() * symbols.length)];
            
            // Completar hasta la longitud deseada
            while (password.length < length) {
                password += charsetArray[Math.floor(Math.random() * charsetArray.length)];
            }
            
            // Mezclar la contraseña
            return password.split('').sort(() => Math.random() - 0.5).join('');
        }
        
        // Función para mostrar toast
        function showToast(message, type = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.position = 'fixed';
                container.style.right = '16px';
                container.style.bottom = '16px';
                container.style.display = 'grid';
                container.style.gap = '8px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }
            const el = document.createElement('div');
            el.textContent = message;
            el.style.padding = '10px 12px';
            el.style.borderRadius = '10px';
            el.style.border = '1px solid #1f2937';
            el.style.background = type === 'error' ? '#3f1d1d' : (type === 'success' ? '#022c22' : '#111827');
            el.style.color = type === 'error' ? '#fecaca' : (type === 'success' ? '#a7f3d0' : '#e5e7eb');
            container.appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }
        
        // Event listener para el medidor de fortaleza
        passwordInput.addEventListener('input', updateStrengthMeter);
        updateStrengthMeter();
        
        // Event listener para el botón de mostrar/ocultar
        toggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'Ocultar';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'Mostrar';
            }
        });
        
        // Event listener para el generador de contraseñas
        generateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            try {
                const generated = generatePassword(16);
                passwordInput.value = generated;
                passwordInput.type = 'text';
                toggleBtn.textContent = 'Ocultar';
                updateStrengthMeter();
                showToast('Contraseña generada', 'success');
            } catch (error) {
                console.error('Error generando contraseña:', error);
                showToast('Error al generar contraseña', 'error');
            }
        });
        
        // Prevenir doble envío del formulario
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function() {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Procesando...';
                }
            });
        }
    }
    
    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEditPassword);
    } else {
        // Si ya está cargado, ejecutar inmediatamente
        setTimeout(initEditPassword, 100);
    }
})();
</script>


